---
- name: Configure Servers
  hosts: all
  gather_facts: no
  tasks:
    - name: Disable UFW
      become: yes
      shell: ufw disable
      ignore_errors: yes

    - name: Disable Swap
      become: yes
      shell: swapoff -a && sed -i '/swap/d' /etc/fstab

    - name: Configure Kernel Parameters
      become: yes
      lineinfile:
        dest: /etc/sysctl.d/kubernetes.conf
        line: "{{ item }}"
      with_items:
        - "net.bridge.bridge-nf-call-ip6tables = 1"
        - "net.bridge.bridge-nf-call-iptables = 1"

    - name: Apply Kernel Parameters
      become: yes
      shell: sysctl --system

    - name: Install Required Packages
      become: yes
      apt:
        name: "{{ item }}"
        state: present
      with_items:
        - ca-certificates
        - curl
        - gnupg
        - open-iscsi
        - nfs-common

    - name: Configure Docker Repository
      become: yes
      shell: |
        sudo install -m 0755 -d /etc/apt/keyrings
        curl -fsSL https://download.docker.com/linux/ubuntu/gpg | sudo gpg --dearmor -o /etc/apt/keyrings/docker.gpg
        sudo chmod a+r /etc/apt/keyrings/docker.gpg
        echo "deb [arch=\"$(dpkg --print-architecture)\" signed-by=/etc/apt/keyrings/docker.gpg] https://download.docker.com/linux/ubuntu $(. /etc/os-release && echo "$VERSION_CODENAME") stable" | sudo tee /etc/apt/sources.list.d/docker.list > /dev/null
        sudo apt-get update
      ignore_errors: yes

    - name: Install Docker
      become: yes
      shell: |
        export DOCKER_VERSION=5:23.0.6-1~ubuntu.20.04~focal
        apt install -y docker-ce=$DOCKER_VERSION docker-ce-cli=$DOCKER_VERSION containerd.io docker-buildx-plugin docker-compose-plugin
      ignore_errors: yes
